# 高并发服务限流特技
* 服务降级  
在高并发情况下，防止用户一直等待，使用服务降级方式（直接返回一个友好的提示给客户端，调用fallBack方法）针对用户体验和高并发限流

* 服务熔断  
熔断机制目的是为了保护服务，在高并发情况下，如果达到一定极限（可以自己设置阈值）如果流量超出了设置阈值，
然后直接拒绝访问，保护当前服务。使用服务降级。服务熔断和服务降级一起使用

* 服务隔离  
雪崩效应产生原因：因为默认情况下，只有一个线程池维护所有的服务接口，如果大量的请求访问同一个接口，
达到tomcat线程池默认极限，可能会导致其他服务无法访问。  
解决服务雪崩效应：使用服务隔离机制（线程池方式和信号量），使用线程池方式实现隔离的原理：相当于每个接口
（服务）都有自己独立的线程池，因为每个线程池互不影响，这样的话就可以解决服务雪崩效应。

* 服务限流  
1.为什么要实现服务限流：
秒杀抢购、双11、服务安全（流量攻击、DDOS）、雪崩效应，因为流量突然特别大  
限流最终的目的是为了保护服务  
2.限流算法  
**计数器方式（传统计数器缺点：临界问题可能违背定义固定速率原则）**  
&ensp;&ensp;&ensp;&ensp;它是限流算法中最简单最容易的一种算法，
比如我们要求某一个接口，1分钟内的请求不能超过10次，我们可以在开始时设置
一个计数器，每次请求，该计数器+1；如果该计数器的值大于10并且与第一次请
求的时间间隔在1分钟内，那么说明请求过多，如果该请求与第一次请求的时间间
隔大于1分钟，并且该计数器的值还在限流范围内，那么重置该计数器<br><br>
**滑动窗口计数器方式**  
&ensp;&ensp;&ensp;&ensp;滑动窗口计数有很多使用场景，比如说限流防止系统
雪崩。相比计数实现，滑动窗口实现会更加平滑，能自动消除毛刺。<br>
滑动窗口原理是在每次有访问进来时，先判断前N个单位时间内的总访问量是否超过
了设置的阈值，并对当前时间片上的请求数+1。<br><br>
**令牌桶方式（Token） guava限流 令牌桶算法**  
&ensp;&ensp;&ensp;&ensp;令牌桶算法是一个存放固定容量令牌的桶，按照固定
速率往桶里添加令牌。令牌桶算法的描述如下：<br>
假设限制2r/s，则按照500毫秒的固定速率往桶中添加令牌；<br>
桶中最多存放b个令牌，当桶满时，新添加的令牌被丢弃或拒绝；<br>
当一个n个字节大小的数据包到达，将从桶中删除n个令牌，接着数据包被发送到网络上；<br>
如果桶中的令牌不足n个，则不会删除令牌，且该数据包将被限流（要么丢弃，要么缓冲区等待）。<br>
&ensp;&ensp;&ensp;&ensp;RateLimiter是guava提供的基于令牌桶算法的实现类，可以非常简单的完成限流
特技，并且根据系统的实际情况来调整生成token的速率。<br>
通常可应用于抢购限流防止冲垮系统；限制某接口、服务单位时间内的访问量，譬如一些第三方服务会对用户访问量进行限制；限制网速，单位时间内只允许上传下载多少字节等。<br><br>
**漏桶方式**  
&ensp;&ensp;&ensp;&ensp;漏桶作为计量工具（The Leaky Bucket Algorithm as a Meter）时，可以用于流量整形（Traffic Shaping）和流量控制（TrafficPolicing），漏桶算法的描述如下：<br>
一个固定容量的漏桶，按照常量固定速率流出水滴；<br>
如果桶是空的，则不需流出水滴；<br>
可以以任意速率流入水滴到漏桶；<br>
如果流入水滴超出了桶的容量，则流入的水滴溢出了（被丢弃），而漏桶容量是不变的。<br>
令牌桶和漏桶对比：<br>
令牌桶是按照固定速率往桶中添加令牌，请求是否被处理需要看桶中令牌是否足够，当令牌数减为零时则拒绝新的请求；<br>
漏桶则是按照常量固定速率流出请求，流入请求（流入请求可以理解为客户端发送请求）速率任意，当流入的请求数累积到漏桶容量时，则新流入的请求被拒绝<br>
令牌桶限制的是平均流入速率（允许突发请求，只要有令牌就可以处理，支持一次拿3个令牌，4个令牌），并允许一定程度突发流量；<br>
漏桶限制的是常量流出速率（即流出速率是一个固定常量值，比如都是1的速率流出，而不能一次是1，下次又是2），从而平滑突发流入速率；<br>
令牌桶允许一定程度的突发，而漏桶主要目的是平滑流入速率；<br>
两个算法实现可以一样，但是方向是相反的，对于相同的参数得到的限流效果是一样的。<br>
另外有时候我们还使用计数器来进行限流，主要用来限制总并发数，比如数据库连接池、线程池、秒杀的并发数；只要全局总请求数或者一定时间段的总请求数设定的阀值则进行限流，是简单粗暴的总数量限流，而不是平均速率限流。<br>
一个固定的漏桶，以常量固定的速率流出水滴。<br>
如果桶中没有水滴的话，则不会流出水滴<br>
如果流入的水滴超过桶中的流量，则流入的水滴可能会发生溢出，溢出的水滴请求是无法访问的，直接调用服务降级方法，桶中的容量是不会发生变化。<br><br>
**应用层限流（Nginx）**  
属于运维配置  


